<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>RxPatterns</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <link href="css/styles.css" rel="stylesheet">

    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-7021819-8"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments)};
        gtag('js', new Date());

        gtag('config', 'UA-7021819-8');
    </script>
</head>
<body>
<div class="container">
    <div class="row" style="margin-bottom: 20px;">
        <h1 class="title">RxPatterns</h1>
    </div>
    <div class="row">
        <div id="sidebar-menu" class="col-2">
            <ul class="main-menu nav nav-stacked affix">
            </ul>
        </div>
        <div id="static-content" class="col-10">
            <h1 id="par-1" style="margin-top: 0px;">Combining</h1>
            <h2 id="sub-par-1-1">Creating pairs</h2>
            <p>
                This demo generates consecutive pairs from a sequence of numbers. This is done by combining the original sequence with the same sequence starting from the second element (the skip(1)). The zip function combines the elements from both streams in order and emits as many items as the source observable with the fewest items.
                See <a href="http://reactivex.io/documentation/operators/zip.html" class="href">Zip function</a>.
            </p>
            <p>
                <!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #888888">// Input:  1 - 2 - 3 - 4 - 5 - 6 - 7 - 8</span>
        <span style="color: #888888">// Output: [1, 2] - [2, 3]-  [3, 4]-  [4, 5] -  [5, 6] - [6, 7], [7, 8]</span>
        <span style="color: #008800; font-weight: bold">final</span> Observable<span style="color: #333333">&lt;</span>Integer<span style="color: #333333">&gt;</span> numbers <span style="color: #333333">=</span> Observable<span style="color: #333333">.</span><span style="color: #0000CC">from</span><span style="color: #333333">(</span>Arrays<span style="color: #333333">.</span><span style="color: #0000CC">asList</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">1</span><span style="color: #333333">,</span> <span style="color: #0000DD; font-weight: bold">2</span><span style="color: #333333">,</span> <span style="color: #0000DD; font-weight: bold">3</span><span style="color: #333333">,</span> <span style="color: #0000DD; font-weight: bold">4</span><span style="color: #333333">,</span> <span style="color: #0000DD; font-weight: bold">5</span><span style="color: #333333">,</span> <span style="color: #0000DD; font-weight: bold">6</span><span style="color: #333333">,</span> <span style="color: #0000DD; font-weight: bold">7</span><span style="color: #333333">,</span> <span style="color: #0000DD; font-weight: bold">8</span><span style="color: #333333">));</span>

        numbers
                <span style="color: #333333">.</span><span style="color: #0000CC">zipWith</span><span style="color: #333333">(</span>numbers
                        <span style="color: #333333">.</span><span style="color: #0000CC">skip</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">1</span><span style="color: #333333">),</span> <span style="color: #333333">(</span>first<span style="color: #333333">,</span> second<span style="color: #333333">)</span> <span style="color: #333333">-&gt;</span> Arrays<span style="color: #333333">.</span><span style="color: #0000CC">asList</span><span style="color: #333333">(</span>first<span style="color: #333333">,</span> second<span style="color: #333333">))</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">subscribe</span><span style="color: #333333">(</span>System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">::</span>println<span style="color: #333333">);</span>
</pre></div>

            </p>
            <h1 id="par-2">Network requests</h1>
            <h2 id="sub-par-2-1">Retrofit Android</h2>
            <p>
                This patterns demos executing a <a href="http://square.github.io/retrofit/">Retrofit</a> request within Android. To always execute the request in the background you can create the RxJavaCallAdapter by using the Schedulers.io() scheduler. For testing you can pass an immediate() or a test scheduler during creation of the API.
            </p>
            <p>
                Make sure that when you touch any views in the subsribe function, you must use observeOn(AndroidSchedulers.mainThread()) because views can only be updated from the main thread. Also use an onError handler to avoid OnErrorNotImplemented exceptions.
            </p>
            <p>
                The subscription is unsubscribed when the network request is finished. It is good practive however to unsubsribe in the proper life-cycle method, for example onPause(). For this you can use a CompositeSubscription and add any subscriptions that must be unsubscribed when the activity pauses. To unsubscribe using a CompositeSubscription call its clear() method. By using the clear() method, the CompositeSubscription can be re-used in contrast to the unsubscribe() method.
            </p>
            <p>
                <!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">public</span> <span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">RetrofitTest</span> <span style="color: #333333">{</span>
    <span style="color: #008800; font-weight: bold">public</span> <span style="color: #008800; font-weight: bold">static</span> <span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">main</span><span style="color: #333333">(</span>String<span style="color: #333333">[]</span> args<span style="color: #333333">)</span> <span style="color: #008800; font-weight: bold">throws</span> IOException <span style="color: #333333">{</span>
        <span style="color: #008800; font-weight: bold">final</span> MockWebServer mockWebServer <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">new</span> MockWebServer<span style="color: #333333">();</span>
        mockWebServer<span style="color: #333333">.</span><span style="color: #0000CC">enqueue</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">new</span> MockResponse<span style="color: #333333">().</span><span style="color: #0000CC">setBody</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;{\&quot;message\&quot;: \&quot;Hallo\&quot;}&quot;</span><span style="color: #333333">).</span><span style="color: #0000CC">setResponseCode</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">200</span><span style="color: #333333">));</span>
        mockWebServer<span style="color: #333333">.</span><span style="color: #0000CC">play</span><span style="color: #333333">();</span>
        <span style="color: #008800; font-weight: bold">final</span> TestApi api <span style="color: #333333">=</span> getApi<span style="color: #333333">(</span>mockWebServer<span style="color: #333333">.</span><span style="color: #0000CC">getUrl</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;/&quot;</span><span style="color: #333333">).</span><span style="color: #0000CC">toString</span><span style="color: #333333">(),</span> Schedulers<span style="color: #333333">.</span><span style="color: #0000CC">io</span><span style="color: #333333">());</span>
        <span style="color: #008800; font-weight: bold">final</span> Subscription subscription <span style="color: #333333">=</span> api<span style="color: #333333">.</span><span style="color: #0000CC">getMessage</span><span style="color: #333333">()</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">observeOn</span><span style="color: #333333">(</span>AndroidSchedulers<span style="color: #333333">.</span><span style="color: #0000CC">mainThread</span><span style="color: #333333">())</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">subscribe</span><span style="color: #333333">(</span>System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">::</span>println<span style="color: #333333">,</span>
                        <span style="color: #997700; font-weight: bold">Throwable:</span><span style="color: #333333">:</span>printStackTrace<span style="color: #333333">);</span>

<span style="color: #888888">//        when result is delivered, subscription is unsubscribed. In Android, best to unsubscribe in lifecycle methods since</span>
        <span style="color: #888888">// the request does not always complete (for example on orientation change, back button etc.)</span>
        System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">.</span><span style="color: #0000CC">println</span><span style="color: #333333">(</span>subscription<span style="color: #333333">.</span><span style="color: #0000CC">isUnsubscribed</span><span style="color: #333333">());</span>

        mockWebServer<span style="color: #333333">.</span><span style="color: #0000CC">shutdown</span><span style="color: #333333">();</span>
    <span style="color: #333333">}</span>

    <span style="color: #008800; font-weight: bold">public</span> <span style="color: #008800; font-weight: bold">static</span> TestApi <span style="color: #0066BB; font-weight: bold">getApi</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">final</span> String baseUrl<span style="color: #333333">,</span> <span style="color: #008800; font-weight: bold">final</span> Scheduler scheduler<span style="color: #333333">)</span> <span style="color: #333333">{</span>
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #008800; font-weight: bold">new</span> Retrofit<span style="color: #333333">.</span><span style="color: #0000CC">Builder</span><span style="color: #333333">()</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">baseUrl</span><span style="color: #333333">(</span>baseUrl<span style="color: #333333">)</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">addCallAdapterFactory</span><span style="color: #333333">(</span>RxJavaCallAdapterFactory<span style="color: #333333">.</span><span style="color: #0000CC">createWithScheduler</span><span style="color: #333333">(</span>scheduler<span style="color: #333333">))</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">addConverterFactory</span><span style="color: #333333">(</span>GsonConverterFactory<span style="color: #333333">.</span><span style="color: #0000CC">create</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">new</span> GsonBuilder<span style="color: #333333">().</span><span style="color: #0000CC">create</span><span style="color: #333333">()))</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">build</span><span style="color: #333333">().</span><span style="color: #0000CC">create</span><span style="color: #333333">(</span>TestApi<span style="color: #333333">.</span><span style="color: #0000CC">class</span><span style="color: #333333">);</span>
    <span style="color: #333333">}</span>
<span style="color: #333333">}</span>
</pre></div>

            </p>
            <h2 id="sub-par-2-2">Combine network requests/responses</h2>
            <p>
                This pattern demonstrates retrieving data from an asynchronous datasource and then using the result of this invocation to retrieve two pieces of data from two other asynchronous data sources and then combining the result of both invocations in one response.
            </p>
            <p>
                Please note that when one of the sources in the zipWith operator fails, no result is retured at all since zipWith needs both observables to emit a value.
            </p>
            <p>
                <!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">public</span> <span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">CombineNetworkRequests</span> <span style="color: #333333">{</span>
    <span style="color: #008800; font-weight: bold">public</span> <span style="color: #008800; font-weight: bold">static</span> <span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">main</span><span style="color: #333333">(</span>String<span style="color: #333333">[]</span> args<span style="color: #333333">)</span> <span style="color: #008800; font-weight: bold">throws</span> IOException <span style="color: #333333">{</span>
        <span style="color: #008800; font-weight: bold">final</span> MockWebServer mockWebServer <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">new</span> MockWebServer<span style="color: #333333">();</span>
        mockWebServer<span style="color: #333333">.</span><span style="color: #0000CC">enqueue</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">new</span> MockResponse<span style="color: #333333">().</span><span style="color: #0000CC">setBody</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;{\&quot;lat\&quot;: 52.2, \&quot;lng\&quot;: 5.1}&quot;</span><span style="color: #333333">).</span><span style="color: #0000CC">setResponseCode</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">200</span><span style="color: #333333">));</span> <span style="color: #888888">// Response for getLastKnownLocation</span>
        mockWebServer<span style="color: #333333">.</span><span style="color: #0000CC">enqueue</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">new</span> MockResponse<span style="color: #333333">().</span><span style="color: #0000CC">setBody</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;{\&quot;lat\&quot;: 52.55, \&quot;lng\&quot;: 5.11}&quot;</span><span style="color: #333333">).</span><span style="color: #0000CC">setResponseCode</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">200</span><span style="color: #333333">));</span> <span style="color: #888888">// Response for resolve location</span>
        mockWebServer<span style="color: #333333">.</span><span style="color: #0000CC">enqueue</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">new</span> MockResponse<span style="color: #333333">().</span><span style="color: #0000CC">setBody</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;{\&quot;temp\&quot;: 18.5}&quot;</span><span style="color: #333333">).</span><span style="color: #0000CC">setResponseCode</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">200</span><span style="color: #333333">));</span> <span style="color: #888888">// Response for weather</span>
        mockWebServer<span style="color: #333333">.</span><span style="color: #0000CC">enqueue</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">new</span> MockResponse<span style="color: #333333">().</span><span style="color: #0000CC">setBody</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;{\&quot;name\&quot;: \&quot;Utrecht\&quot;}&quot;</span><span style="color: #333333">).</span><span style="color: #0000CC">setResponseCode</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">200</span><span style="color: #333333">));</span> <span style="color: #888888">// Response for location</span>
        mockWebServer<span style="color: #333333">.</span><span style="color: #0000CC">start</span><span style="color: #333333">();</span>

        <span style="color: #008800; font-weight: bold">final</span> String baseUrl <span style="color: #333333">=</span> mockWebServer<span style="color: #333333">.</span><span style="color: #0000CC">url</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;/&quot;</span><span style="color: #333333">).</span><span style="color: #0000CC">toString</span><span style="color: #333333">();</span>
        <span style="color: #008800; font-weight: bold">final</span> LocationApi locationApi <span style="color: #333333">=</span> RetroFitFactory<span style="color: #333333">.</span><span style="color: #0000CC">getApi</span><span style="color: #333333">(</span>baseUrl<span style="color: #333333">,</span> Schedulers<span style="color: #333333">.</span><span style="color: #0000CC">immediate</span><span style="color: #333333">()).</span><span style="color: #0000CC">create</span><span style="color: #333333">(</span>LocationApi<span style="color: #333333">.</span><span style="color: #0000CC">class</span><span style="color: #333333">);</span>
        <span style="color: #008800; font-weight: bold">final</span> WeatherApi weatherApi <span style="color: #333333">=</span> RetroFitFactory<span style="color: #333333">.</span><span style="color: #0000CC">getApi</span><span style="color: #333333">(</span>baseUrl<span style="color: #333333">,</span> Schedulers<span style="color: #333333">.</span><span style="color: #0000CC">immediate</span><span style="color: #333333">()).</span><span style="color: #0000CC">create</span><span style="color: #333333">(</span>WeatherApi<span style="color: #333333">.</span><span style="color: #0000CC">class</span><span style="color: #333333">);</span>
        <span style="color: #008800; font-weight: bold">final</span> PlacesApi placesApi <span style="color: #333333">=</span> RetroFitFactory<span style="color: #333333">.</span><span style="color: #0000CC">getApi</span><span style="color: #333333">(</span>baseUrl<span style="color: #333333">,</span> Schedulers<span style="color: #333333">.</span><span style="color: #0000CC">immediate</span><span style="color: #333333">()).</span><span style="color: #0000CC">create</span><span style="color: #333333">(</span>PlacesApi<span style="color: #333333">.</span><span style="color: #0000CC">class</span><span style="color: #333333">);</span>

        getLastKnownLocationObservable<span style="color: #333333">(</span>locationApi<span style="color: #333333">).</span><span style="color: #0000CC">switchIfEmpty</span><span style="color: #333333">(</span>locationApi<span style="color: #333333">.</span><span style="color: #0000CC">resolveUserLocation</span><span style="color: #333333">())</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">flatMap</span><span style="color: #333333">(</span>location <span style="color: #333333">-&gt;</span> weatherApi<span style="color: #333333">.</span><span style="color: #0000CC">getTemp</span><span style="color: #333333">(</span>location<span style="color: #333333">.</span><span style="color: #0000CC">lat</span><span style="color: #333333">,</span> location<span style="color: #333333">.</span><span style="color: #0000CC">lng</span><span style="color: #333333">)</span>
                        <span style="color: #333333">.</span><span style="color: #0000CC">zipWith</span><span style="color: #333333">(</span>placesApi<span style="color: #333333">.</span><span style="color: #0000CC">reverseGeocode</span><span style="color: #333333">(</span>location<span style="color: #333333">.</span><span style="color: #0000CC">lat</span><span style="color: #333333">,</span> location<span style="color: #333333">.</span><span style="color: #0000CC">lng</span><span style="color: #333333">),</span> <span style="color: #333333">(</span>Func2<span style="color: #333333">&lt;</span>Weather<span style="color: #333333">,</span> City<span style="color: #333333">,</span> Pair<span style="color: #333333">&gt;)</span> <span style="color: #997700; font-weight: bold">Pair:</span><span style="color: #333333">:</span><span style="color: #008800; font-weight: bold">new</span><span style="color: #333333">))</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">subscribe</span><span style="color: #333333">(</span>System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">::</span>println<span style="color: #333333">);</span>

        mockWebServer<span style="color: #333333">.</span><span style="color: #0000CC">shutdown</span><span style="color: #333333">();</span>
    <span style="color: #333333">}</span>

    <span style="color: #008800; font-weight: bold">private</span> <span style="color: #008800; font-weight: bold">static</span> Observable<span style="color: #333333">&lt;</span>Location<span style="color: #333333">&gt;</span> <span style="color: #0066BB; font-weight: bold">getLastKnownLocationObservable</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">final</span> LocationApi locationApi<span style="color: #333333">)</span> <span style="color: #333333">{</span>
<span style="color: #888888">//        return Observable.empty();</span>
        <span style="color: #008800; font-weight: bold">return</span> locationApi<span style="color: #333333">.</span><span style="color: #0000CC">getLastKnownLocation</span><span style="color: #333333">();</span>
    <span style="color: #333333">}</span>
<span style="color: #333333">}</span>
</pre></div>

            </p>
            <h2 id="sub-par-2-3">Cache network responses</h2>
            <p>
                This pattern demonstrates a strategy for caching network data using reactive extensions. It is a common pattern to cache data a specific time before fetching it again from a network. The basic flow is as follows:

                <ol>
                    <li>Fetch data from the in-memory store if it exists and is not stale.</li>
                    <li>Fetch data from the disk store if it exists and is not stale.</li>
                    <li>Fetch data from the network.</li>
                    <li>If succesfull, populate the in-memory and disk store.</li>
                    <li>If not succesfull, retrieve potential stale data from the disk cache if it exists (this disk cache acts as a fallback mechanism).</li>
                    <li>If no data exists in the disk cache, reply with an error.</li>
                </ol>
            </p>
            <p>
                The in-memory and disk cache may use different expiry policies. The in-memory cache may have a size- and time-based constraint while the disk cache only has a time-based constraint. The disk cache will survive application restarts while the in-memory cache may not.
            </p>
            <p>
                When using the disk cache as a fallback mechanism in case of network errors, think about what to show to the user. Perhaps the timestamp of the data so the user knows the data is not up-to-date and may need to be refresed later.
            </p>
            <p>
                Remember this is not the only way to handle this scenario. You might implement an <a
                    href="#sub-par-4-2">exponential backoff </a> algorithm when retrieving data from the network before using the disk cache as a fallback mechanism.
            </p>
            <p>
                <!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">public</span> <span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">CacheNetworkResponses</span> <span style="color: #333333">{</span>
    <span style="color: #008800; font-weight: bold">private</span> <span style="color: #008800; font-weight: bold">static</span> <span style="color: #333399; font-weight: bold">boolean</span> simulateNetworkError<span style="color: #333333">;</span>

    <span style="color: #008800; font-weight: bold">public</span> <span style="color: #008800; font-weight: bold">static</span> <span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">main</span><span style="color: #333333">(</span>String<span style="color: #333333">[]</span> args<span style="color: #333333">)</span> <span style="color: #333333">{</span>
        <span style="color: #008800; font-weight: bold">final</span> Cache memoryCache <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">new</span> Cache<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;MEMORY&quot;</span><span style="color: #333333">),</span> diskCache <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">new</span> Cache<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;DISK&quot;</span><span style="color: #333333">);</span>

        <span style="color: #008800; font-weight: bold">final</span> Observable<span style="color: #333333">&lt;</span>String<span style="color: #333333">&gt;</span> multipleSources <span style="color: #333333">=</span> Observable<span style="color: #333333">.</span><span style="color: #0000CC">concat</span><span style="color: #333333">(</span>
                memoryCache<span style="color: #333333">.</span><span style="color: #0000CC">getFromCache</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">false</span><span style="color: #333333">),</span>
                diskCache<span style="color: #333333">.</span><span style="color: #0000CC">getFromCache</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">false</span><span style="color: #333333">),</span>
                fromNetwork<span style="color: #333333">()</span>
                        <span style="color: #333333">.</span><span style="color: #0000CC">doOnNext</span><span style="color: #333333">(</span><span style="color: #997700; font-weight: bold">memoryCache:</span><span style="color: #333333">:</span>putInCache<span style="color: #333333">)</span>
                        <span style="color: #333333">.</span><span style="color: #0000CC">doOnNext</span><span style="color: #333333">(</span><span style="color: #997700; font-weight: bold">diskCache:</span><span style="color: #333333">:</span>putInCache<span style="color: #333333">)</span>
                        <span style="color: #333333">.</span><span style="color: #0000CC">onErrorResumeNext</span><span style="color: #333333">(</span>throwable <span style="color: #333333">-&gt;</span>
                                diskCache<span style="color: #333333">.</span><span style="color: #0000CC">getFromCache</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">true</span><span style="color: #333333">)</span>
                                        <span style="color: #333333">.</span><span style="color: #0000CC">filter</span><span style="color: #333333">(</span><span style="color: #997700; font-weight: bold">Objects:</span><span style="color: #333333">:</span>nonNull<span style="color: #333333">)</span>
                                        <span style="color: #333333">.</span><span style="color: #0000CC">switchIfEmpty</span><span style="color: #333333">(</span>Observable<span style="color: #333333">.</span><span style="color: #0000CC">error</span><span style="color: #333333">(</span>throwable<span style="color: #333333">)))</span>
        <span style="color: #333333">)</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">take</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">1</span><span style="color: #333333">);</span>

        multipleSources
                <span style="color: #333333">.</span><span style="color: #0000CC">subscribe</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">new</span> DataSubscriber<span style="color: #333333">());</span>

        multipleSources
                <span style="color: #333333">.</span><span style="color: #0000CC">subscribe</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">new</span> DataSubscriber<span style="color: #333333">());</span>

        memoryCache<span style="color: #333333">.</span><span style="color: #0000CC">invalidate</span><span style="color: #333333">();</span>

        multipleSources
                <span style="color: #333333">.</span><span style="color: #0000CC">subscribe</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">new</span> DataSubscriber<span style="color: #333333">());</span>

        simulateNetworkError <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">true</span><span style="color: #333333">;</span>
        diskCache<span style="color: #333333">.</span><span style="color: #0000CC">stale</span> <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">true</span><span style="color: #333333">;</span>

        multipleSources
                <span style="color: #333333">.</span><span style="color: #0000CC">subscribe</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">new</span> DataSubscriber<span style="color: #333333">());</span>

        simulateNetworkError <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">true</span><span style="color: #333333">;</span>
        diskCache<span style="color: #333333">.</span><span style="color: #0000CC">cached</span> <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">null</span><span style="color: #333333">;</span>

        multipleSources
                <span style="color: #333333">.</span><span style="color: #0000CC">subscribe</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">new</span> DataSubscriber<span style="color: #333333">());</span>
    <span style="color: #333333">}</span>

    <span style="color: #008800; font-weight: bold">static</span> Observable<span style="color: #333333">&lt;</span>String<span style="color: #333333">&gt;</span> <span style="color: #0066BB; font-weight: bold">fromNetwork</span><span style="color: #333333">()</span> <span style="color: #333333">{</span>
        <span style="color: #008800; font-weight: bold">return</span> Observable<span style="color: #333333">.</span><span style="color: #0000CC">fromCallable</span><span style="color: #333333">(()</span> <span style="color: #333333">-&gt;</span> <span style="color: #333333">{</span>
            System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">.</span><span style="color: #0000CC">println</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;getFrom NETWORK&quot;</span><span style="color: #333333">);</span>
            <span style="color: #008800; font-weight: bold">if</span> <span style="color: #333333">(</span>simulateNetworkError<span style="color: #333333">)</span> <span style="color: #333333">{</span>
                <span style="color: #008800; font-weight: bold">throw</span> <span style="color: #008800; font-weight: bold">new</span> <span style="color: #0066BB; font-weight: bold">RuntimeException</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Network error occurred&quot;</span><span style="color: #333333">);</span>
            <span style="color: #333333">}</span>
            <span style="color: #008800; font-weight: bold">return</span> <span style="background-color: #fff0f0">&quot;value&quot;</span><span style="color: #333333">;</span>
        <span style="color: #333333">});</span>
    <span style="color: #333333">}</span>

    <span style="color: #008800; font-weight: bold">private</span> <span style="color: #008800; font-weight: bold">static</span> <span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">Cache</span> <span style="color: #333333">{</span>
        <span style="color: #008800; font-weight: bold">final</span> String type<span style="color: #333333">;</span>
        <span style="color: #333399; font-weight: bold">boolean</span> stale<span style="color: #333333">;</span>
        String cached<span style="color: #333333">;</span>

        <span style="color: #008800; font-weight: bold">private</span> <span style="color: #0066BB; font-weight: bold">Cache</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">final</span> String type<span style="color: #333333">)</span> <span style="color: #333333">{</span>
            <span style="color: #008800; font-weight: bold">this</span><span style="color: #333333">.</span><span style="color: #0000CC">type</span> <span style="color: #333333">=</span> type<span style="color: #333333">;</span>
        <span style="color: #333333">}</span>

        Observable<span style="color: #333333">&lt;</span>String<span style="color: #333333">&gt;</span> <span style="color: #0066BB; font-weight: bold">getFromCache</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">final</span> <span style="color: #333399; font-weight: bold">boolean</span> ignoreStaleData<span style="color: #333333">)</span> <span style="color: #333333">{</span>
            <span style="color: #008800; font-weight: bold">return</span> Observable<span style="color: #333333">.</span><span style="color: #0000CC">defer</span><span style="color: #333333">(()</span> <span style="color: #333333">-&gt;</span> <span style="color: #333333">{</span>
                System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">.</span><span style="color: #0000CC">println</span><span style="color: #333333">(</span>String<span style="color: #333333">.</span><span style="color: #0000CC">format</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;getFrom [%s]&quot;</span><span style="color: #333333">,</span> type<span style="color: #333333">));</span>
                <span style="color: #008800; font-weight: bold">if</span> <span style="color: #333333">(</span>cached <span style="color: #333333">==</span> <span style="color: #008800; font-weight: bold">null</span> <span style="color: #333333">||</span> <span style="color: #333333">(</span>stale <span style="color: #333333">&amp;&amp;</span> <span style="color: #333333">!</span>ignoreStaleData<span style="color: #333333">))</span> <span style="color: #333333">{</span>
                    <span style="color: #008800; font-weight: bold">return</span> Observable<span style="color: #333333">.</span><span style="color: #0000CC">empty</span><span style="color: #333333">();</span>
                <span style="color: #333333">}</span>

                <span style="color: #008800; font-weight: bold">return</span> Observable<span style="color: #333333">.</span><span style="color: #0000CC">just</span><span style="color: #333333">(</span>cached<span style="color: #333333">);</span>
            <span style="color: #333333">});</span>
        <span style="color: #333333">}</span>

        <span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">putInCache</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">final</span> String value<span style="color: #333333">)</span> <span style="color: #333333">{</span>
            cached <span style="color: #333333">=</span> value<span style="color: #333333">;</span>
        <span style="color: #333333">}</span>

        <span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">invalidate</span><span style="color: #333333">()</span> <span style="color: #333333">{</span>
            cached <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">null</span><span style="color: #333333">;</span>
        <span style="color: #333333">}</span>
    <span style="color: #333333">}</span>

    <span style="color: #008800; font-weight: bold">private</span> <span style="color: #008800; font-weight: bold">static</span> <span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">DataSubscriber</span> <span style="color: #008800; font-weight: bold">extends</span> Subscriber<span style="color: #333333">&lt;</span>String<span style="color: #333333">&gt;</span> <span style="color: #333333">{</span>
        <span style="color: #555555; font-weight: bold">@Override</span>
        <span style="color: #008800; font-weight: bold">public</span> <span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">onCompleted</span><span style="color: #333333">()</span> <span style="color: #333333">{</span>

        <span style="color: #333333">}</span>

        <span style="color: #555555; font-weight: bold">@Override</span>
        <span style="color: #008800; font-weight: bold">public</span> <span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">onError</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">final</span> Throwable e<span style="color: #333333">)</span> <span style="color: #333333">{</span>
            System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">.</span><span style="color: #0000CC">println</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Cannot load data&quot;</span><span style="color: #333333">);</span>
        <span style="color: #333333">}</span>

        <span style="color: #555555; font-weight: bold">@Override</span>
        <span style="color: #008800; font-weight: bold">public</span> <span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">onNext</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">final</span> String s<span style="color: #333333">)</span> <span style="color: #333333">{</span>
            System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">.</span><span style="color: #0000CC">println</span><span style="color: #333333">(</span>s<span style="color: #333333">);</span>
        <span style="color: #333333">}</span>
    <span style="color: #333333">}</span>
<span style="color: #333333">}</span>
</pre></div>
            </p>
            <h1 id="par-3">Various</h1>
            <h2 id="sub-par-3-1">Scheduling network requests</h2>
            <p>
                This pattern demonstrates scheduling periodic network requests which can be useful for keeping data up-to-date where web sockets or some other pusb based technology is not an option. To retrieve data from the network the switchMap operator is used instead of the
                flatMap operator. The difference between those operators is explained <a
                    href="https://medium.com/appunite-edu-collection/rxjava-flatmap-switchmap-and-concatmap-differences-examples-6d1f3ff88ee0">here.</a>
            </p>
            <p>
                To make sure the scheduler does not die when the Observable in switchMap emits an error, the onErrorResumeNext function is used to provide an alternative response in case of errors.
            </p>
            <p>
                <!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">public</span> <span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">SchedulingExceptionDemo</span> <span style="color: #333333">{</span>
    <span style="color: #008800; font-weight: bold">public</span> <span style="color: #008800; font-weight: bold">static</span> <span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">main</span><span style="color: #333333">(</span>String<span style="color: #333333">[]</span> args<span style="color: #333333">)</span> <span style="color: #008800; font-weight: bold">throws</span> IOException <span style="color: #333333">{</span>
        <span style="color: #008800; font-weight: bold">final</span> MockWebServer mockWebServer <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">new</span> MockWebServer<span style="color: #333333">();</span>
        <span style="color: #008800; font-weight: bold">for</span> <span style="color: #333333">(</span><span style="color: #333399; font-weight: bold">int</span> i <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span><span style="color: #333333">;</span> i <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">10</span><span style="color: #333333">;</span> i<span style="color: #333333">++)</span> <span style="color: #333333">{</span>
            <span style="color: #008800; font-weight: bold">if</span> <span style="color: #333333">(</span>i <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">2</span><span style="color: #333333">)</span> <span style="color: #333333">{</span>
                mockWebServer<span style="color: #333333">.</span><span style="color: #0000CC">enqueue</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">new</span> MockResponse<span style="color: #333333">().</span><span style="color: #0000CC">setBody</span><span style="color: #333333">(</span>DepartureTimes<span style="color: #333333">.</span><span style="color: #0000CC">getBody</span><span style="color: #333333">(</span>i<span style="color: #333333">)).</span><span style="color: #0000CC">setResponseCode</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">500</span><span style="color: #333333">));</span>
            <span style="color: #333333">}</span> <span style="color: #008800; font-weight: bold">else</span> <span style="color: #333333">{</span>
                mockWebServer<span style="color: #333333">.</span><span style="color: #0000CC">enqueue</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">new</span> MockResponse<span style="color: #333333">().</span><span style="color: #0000CC">setBody</span><span style="color: #333333">(</span>DepartureTimes<span style="color: #333333">.</span><span style="color: #0000CC">getBody</span><span style="color: #333333">(</span>i<span style="color: #333333">)).</span><span style="color: #0000CC">setResponseCode</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">200</span><span style="color: #333333">));</span>
            <span style="color: #333333">}</span>
        <span style="color: #333333">}</span>
        mockWebServer<span style="color: #333333">.</span><span style="color: #0000CC">start</span><span style="color: #333333">();</span>

        <span style="color: #008800; font-weight: bold">final</span> DepartureTimesApi departureTimesApi <span style="color: #333333">=</span> RetroFitFactory<span style="color: #333333">.</span><span style="color: #0000CC">getApi</span><span style="color: #333333">(</span>mockWebServer<span style="color: #333333">.</span><span style="color: #0000CC">url</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;/&quot;</span><span style="color: #333333">).</span><span style="color: #0000CC">toString</span><span style="color: #333333">(),</span> Schedulers<span style="color: #333333">.</span><span style="color: #0000CC">immediate</span><span style="color: #333333">()).</span><span style="color: #0000CC">create</span><span style="color: #333333">(</span>DepartureTimesApi<span style="color: #333333">.</span><span style="color: #0000CC">class</span><span style="color: #333333">);</span>

        <span style="color: #008800; font-weight: bold">final</span> TestScheduler testScheduler <span style="color: #333333">=</span> Schedulers<span style="color: #333333">.</span><span style="color: #0000CC">test</span><span style="color: #333333">();</span>
        Observable<span style="color: #333333">.</span><span style="color: #0000CC">interval</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">1</span><span style="color: #333333">,</span> TimeUnit<span style="color: #333333">.</span><span style="color: #0000CC">SECONDS</span><span style="color: #333333">,</span> testScheduler<span style="color: #333333">)</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">doOnNext</span><span style="color: #333333">(</span>i <span style="color: #333333">-&gt;</span> System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">.</span><span style="color: #0000CC">println</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;INTERVAL = &quot;</span> <span style="color: #333333">+</span> i<span style="color: #333333">))</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">switchMap</span><span style="color: #333333">(</span>i <span style="color: #333333">-&gt;</span> departureTimesApi<span style="color: #333333">.</span><span style="color: #0000CC">getDepartureTimes</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;ut&quot;</span><span style="color: #333333">)</span> <span style="color: #888888">// switchMap only processes the latest event from the source (flatMap processes everything)</span>
                        <span style="color: #333333">.</span><span style="color: #0000CC">doOnError</span><span style="color: #333333">(</span>throwable <span style="color: #333333">-&gt;</span> System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">.</span><span style="color: #0000CC">println</span><span style="color: #333333">(</span>throwable<span style="color: #333333">.</span><span style="color: #0000CC">getMessage</span><span style="color: #333333">()))</span> <span style="color: #888888">// Log error</span>
                        <span style="color: #333333">.</span><span style="color: #0000CC">onErrorResumeNext</span><span style="color: #333333">(</span>Observable<span style="color: #333333">.</span><span style="color: #0000CC">empty</span><span style="color: #333333">()))</span> <span style="color: #888888">// Return empty observable</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">subscribe</span><span style="color: #333333">(</span>System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">::</span>println<span style="color: #333333">);</span>

        testScheduler<span style="color: #333333">.</span><span style="color: #0000CC">advanceTimeBy</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">1</span><span style="color: #333333">,</span> TimeUnit<span style="color: #333333">.</span><span style="color: #0000CC">SECONDS</span><span style="color: #333333">);</span>
        testScheduler<span style="color: #333333">.</span><span style="color: #0000CC">advanceTimeBy</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">1</span><span style="color: #333333">,</span> TimeUnit<span style="color: #333333">.</span><span style="color: #0000CC">SECONDS</span><span style="color: #333333">);</span>
        testScheduler<span style="color: #333333">.</span><span style="color: #0000CC">advanceTimeBy</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">1</span><span style="color: #333333">,</span> TimeUnit<span style="color: #333333">.</span><span style="color: #0000CC">SECONDS</span><span style="color: #333333">);</span>
        testScheduler<span style="color: #333333">.</span><span style="color: #0000CC">advanceTimeBy</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">1</span><span style="color: #333333">,</span> TimeUnit<span style="color: #333333">.</span><span style="color: #0000CC">SECONDS</span><span style="color: #333333">);</span>

        mockWebServer<span style="color: #333333">.</span><span style="color: #0000CC">shutdown</span><span style="color: #333333">();</span>
    <span style="color: #333333">}</span>
<span style="color: #333333">}</span>
</pre></div>

            </p>
            <h2 id="sub-par-3-2">Sharing values</h2>
            <p>
                A common pattern is sharing the result of an Observable between multiple subsribers, for example a network call. For demonstration purposes the System::nanoTime is emitted. By using the combination of
                <ol>
                    <li><a href="http://reactivex.io/RxJava/1.x/javadoc/rx/Observable.html#share--">share</a> multicasts the original observer as long as there is at least one subscriber.</li>
                    <li><a href="http://reactivex.io/RxJava/1.x/javadoc/rx/Observable.html#replay--">replay</a>  returns a ConnectableObservable that shares a single subscription to the underlying Observable that will replay all of its items and notifications to any future Observer.</li>
                    <li>
                        <a href="http://reactivex.io/RxJava/1.x/javadoc/rx/observables/ConnectableObservable.html#autoConnect--">autoConnect</a> returns an Observable that automatically connects to this ConnectableObservable when the first Subscriber subscribes.</li>
                </ol>
                we are able to share the first emitted nanoTime value to all subscribers.
            </p>
            <p>
                <!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">public</span> <span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">SharingValues</span> <span style="color: #333333">{</span>
    <span style="color: #008800; font-weight: bold">public</span> <span style="color: #008800; font-weight: bold">static</span> <span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">main</span><span style="color: #333333">(</span>String<span style="color: #333333">[]</span> args<span style="color: #333333">)</span> <span style="color: #333333">{</span>
        <span style="color: #008800; font-weight: bold">final</span> Observable<span style="color: #333333">&lt;</span>Long<span style="color: #333333">&gt;</span> obs <span style="color: #333333">=</span> Observable<span style="color: #333333">.</span><span style="color: #0000CC">fromCallable</span><span style="color: #333333">(</span><span style="color: #997700; font-weight: bold">System:</span><span style="color: #333333">:</span>nanoTime<span style="color: #333333">).</span><span style="color: #0000CC">share</span><span style="color: #333333">().</span><span style="color: #0000CC">replay</span><span style="color: #333333">().</span><span style="color: #0000CC">autoConnect</span><span style="color: #333333">();</span>

        obs<span style="color: #333333">.</span><span style="color: #0000CC">subscribe</span><span style="color: #333333">(</span>System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">::</span>println<span style="color: #333333">);</span>
        obs<span style="color: #333333">.</span><span style="color: #0000CC">subscribe</span><span style="color: #333333">(</span>System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">::</span>println<span style="color: #333333">);</span>
        obs<span style="color: #333333">.</span><span style="color: #0000CC">subscribe</span><span style="color: #333333">(</span>System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">::</span>println<span style="color: #333333">);</span>
    <span style="color: #333333">}</span>
<span style="color: #333333">}</span>
</pre></div>

            </p>

            <h1 id="par-4">Functional</h1>
            <h2 id="sub-par-4-1">Auto suggest</h2>
            <p>
                The auto suggest demo, demonstrates a possible implementation for text based suggestion using rx. The following solution address the following, functional problems:
                <ol>
                    <li>Only execute a search request if there are at least 3 characters typed in by the user. The filter operator is used for this.</li>
                    <li>Do not execute search requests when the user types in characters too fast. The debounce operator is used for this.</li>
                    <li>Make sure older search results are disgarded when the user has typed additional characters to further limit the search. switchMap is used instaed of flatMap.</li>
                </ol>
            </p>
            <p>
                <!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">public</span> <span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">AutoSuggest</span> <span style="color: #333333">{</span>
    <span style="color: #008800; font-weight: bold">private</span> <span style="color: #008800; font-weight: bold">static</span> <span style="color: #008800; font-weight: bold">final</span> <span style="color: #333399; font-weight: bold">int</span><span style="color: #333333">[]</span> SLEEP_TIMES <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">new</span> <span style="color: #333399; font-weight: bold">int</span><span style="color: #333333">[]{</span><span style="color: #0000DD; font-weight: bold">30</span><span style="color: #333333">,</span> <span style="color: #0000DD; font-weight: bold">30</span><span style="color: #333333">,</span> <span style="color: #0000DD; font-weight: bold">30</span><span style="color: #333333">,</span> <span style="color: #0000DD; font-weight: bold">30</span><span style="color: #333333">,</span> <span style="color: #0000DD; font-weight: bold">10</span><span style="color: #333333">,</span> <span style="color: #0000DD; font-weight: bold">10</span><span style="color: #333333">,</span> <span style="color: #0000DD; font-weight: bold">10</span><span style="color: #333333">,</span> <span style="color: #0000DD; font-weight: bold">30</span><span style="color: #333333">,</span> <span style="color: #0000DD; font-weight: bold">30</span><span style="color: #333333">,</span> <span style="color: #0000DD; font-weight: bold">10</span><span style="color: #333333">,</span> <span style="color: #0000DD; font-weight: bold">10</span><span style="color: #333333">,</span> <span style="color: #0000DD; font-weight: bold">30</span><span style="color: #333333">,</span> <span style="color: #0000DD; font-weight: bold">30</span><span style="color: #333333">};</span>

    <span style="color: #008800; font-weight: bold">public</span> <span style="color: #008800; font-weight: bold">static</span> <span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">main</span><span style="color: #333333">(</span>String<span style="color: #333333">[]</span> args<span style="color: #333333">)</span> <span style="color: #008800; font-weight: bold">throws</span> InterruptedException <span style="color: #333333">{</span>
        <span style="color: #008800; font-weight: bold">final</span> AutoSuggestService autoSuggestService <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">new</span> AutoSuggestService<span style="color: #333333">();</span>
        <span style="color: #008800; font-weight: bold">final</span> PublishSubject<span style="color: #333333">&lt;</span>String<span style="color: #333333">&gt;</span> searchField <span style="color: #333333">=</span> PublishSubject<span style="color: #333333">.</span><span style="color: #0000CC">create</span><span style="color: #333333">();</span>

        searchField
                <span style="color: #333333">.</span><span style="color: #0000CC">filter</span><span style="color: #333333">(</span>input <span style="color: #333333">-&gt;</span> input<span style="color: #333333">.</span><span style="color: #0000CC">length</span><span style="color: #333333">()</span> <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">2</span><span style="color: #333333">)</span> <span style="color: #888888">// Only search when input contains 3 characters or more</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">debounce</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">25</span><span style="color: #333333">,</span> TimeUnit<span style="color: #333333">.</span><span style="color: #0000CC">MILLISECONDS</span><span style="color: #333333">)</span> <span style="color: #888888">// Do not search immediately when typing fast</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">switchMap</span><span style="color: #333333">(</span>input <span style="color: #333333">-&gt;</span> autoSuggestService<span style="color: #333333">.</span><span style="color: #0000CC">suggest</span><span style="color: #333333">(</span>input<span style="color: #333333">)</span> <span style="color: #888888">// switchMap makes sure old requests are discard</span>
                        <span style="color: #333333">.</span><span style="color: #0000CC">doOnError</span><span style="color: #333333">(</span>System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">::</span>println<span style="color: #333333">)</span>
                        <span style="color: #333333">.</span><span style="color: #0000CC">onErrorResumeNext</span><span style="color: #333333">(</span>throwable <span style="color: #333333">-&gt;</span> Observable<span style="color: #333333">.</span><span style="color: #0000CC">just</span><span style="color: #333333">(</span>Collections<span style="color: #333333">.</span><span style="color: #0000CC">emptyList</span><span style="color: #333333">())))</span> <span style="color: #888888">// Do not die on onError</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">subscribe</span><span style="color: #333333">(</span>System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">::</span>println<span style="color: #333333">);</span>

        <span style="color: #008800; font-weight: bold">final</span> String input <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;Amsterdam Kor&quot;</span><span style="color: #333333">;</span>
        <span style="color: #008800; font-weight: bold">for</span> <span style="color: #333333">(</span><span style="color: #333399; font-weight: bold">int</span> i <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span><span style="color: #333333">;</span> i <span style="color: #333333">&lt;</span> input<span style="color: #333333">.</span><span style="color: #0000CC">length</span><span style="color: #333333">();</span> i<span style="color: #333333">++)</span> <span style="color: #333333">{</span>
            searchField<span style="color: #333333">.</span><span style="color: #0000CC">onNext</span><span style="color: #333333">(</span>input<span style="color: #333333">.</span><span style="color: #0000CC">substring</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">0</span><span style="color: #333333">,</span> i<span style="color: #333333">));</span>
            Thread<span style="color: #333333">.</span><span style="color: #0000CC">sleep</span><span style="color: #333333">(</span>SLEEP_TIMES<span style="color: #333333">[</span>i<span style="color: #333333">]);</span>
        <span style="color: #333333">}</span>
    <span style="color: #333333">}</span>

    <span style="color: #008800; font-weight: bold">private</span> <span style="color: #008800; font-weight: bold">static</span> <span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">AutoSuggestService</span> <span style="color: #333333">{</span>
        <span style="color: #008800; font-weight: bold">private</span> <span style="color: #008800; font-weight: bold">final</span> Map<span style="color: #333333">&lt;</span>String<span style="color: #333333">,</span> List<span style="color: #333333">&lt;</span>String<span style="color: #333333">&gt;&gt;</span> results <span style="color: #333333">=</span> initSearchResults<span style="color: #333333">();</span>

        <span style="color: #008800; font-weight: bold">private</span> Map<span style="color: #333333">&lt;</span>String<span style="color: #333333">,</span> List<span style="color: #333333">&lt;</span>String<span style="color: #333333">&gt;&gt;</span> initSearchResults<span style="color: #333333">()</span> <span style="color: #333333">{</span>
            <span style="color: #008800; font-weight: bold">final</span> Map<span style="color: #333333">&lt;</span>String<span style="color: #333333">,</span> List<span style="color: #333333">&lt;</span>String<span style="color: #333333">&gt;&gt;</span> values <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">new</span> HashMap<span style="color: #333333">&lt;&gt;();</span>
            values<span style="color: #333333">.</span><span style="color: #0000CC">put</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;&quot;</span><span style="color: #333333">,</span> Arrays<span style="color: #333333">.</span><span style="color: #0000CC">asList</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Amsterdam Kerkstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Alkmaar Kerkstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amstelveen Kruisstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Abcoude Kerkstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Almere Kerkplein&quot;</span><span style="color: #333333">));</span>
            values<span style="color: #333333">.</span><span style="color: #0000CC">put</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;A&quot;</span><span style="color: #333333">,</span> Arrays<span style="color: #333333">.</span><span style="color: #0000CC">asList</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Amsterdam Kerkstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Alkmaar Kerkstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amstelveen Kruisstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Abcoude Kerkstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Almere Kerkplein&quot;</span><span style="color: #333333">));</span>
            values<span style="color: #333333">.</span><span style="color: #0000CC">put</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Am&quot;</span><span style="color: #333333">,</span> Arrays<span style="color: #333333">.</span><span style="color: #0000CC">asList</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Amsterdam Kerkstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Kalverstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amstelveen Kruisstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amstelveen Kromweg&quot;</span><span style="color: #333333">));</span>
            values<span style="color: #333333">.</span><span style="color: #0000CC">put</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Ams&quot;</span><span style="color: #333333">,</span> Arrays<span style="color: #333333">.</span><span style="color: #0000CC">asList</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Amsterdam Kerkstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Kalverstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amstelveen Kruisstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amstelveen KraalWeg&quot;</span><span style="color: #333333">));</span>
            values<span style="color: #333333">.</span><span style="color: #0000CC">put</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Amst&quot;</span><span style="color: #333333">,</span> Arrays<span style="color: #333333">.</span><span style="color: #0000CC">asList</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Amsterdam Kerkstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Kalverstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amstelveen Kruisstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amstelveen KromWeg&quot;</span><span style="color: #333333">));</span>
            values<span style="color: #333333">.</span><span style="color: #0000CC">put</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Amste&quot;</span><span style="color: #333333">,</span> Arrays<span style="color: #333333">.</span><span style="color: #0000CC">asList</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Amsterdam Kerkstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Kalverstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amstelveen Kruisstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amstelveen Kromweg&quot;</span><span style="color: #333333">));</span>
            values<span style="color: #333333">.</span><span style="color: #0000CC">put</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Amster&quot;</span><span style="color: #333333">,</span> Arrays<span style="color: #333333">.</span><span style="color: #0000CC">asList</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Amsterdam Kerkstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Kalverstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Kometensingel&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Elpermeer&quot;</span><span style="color: #333333">));</span>
            values<span style="color: #333333">.</span><span style="color: #0000CC">put</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Amsterd&quot;</span><span style="color: #333333">,</span> Arrays<span style="color: #333333">.</span><span style="color: #0000CC">asList</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Amsterdam Kerkstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Kalverstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Kometensingel&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Elpermeer&quot;</span><span style="color: #333333">));</span>
            values<span style="color: #333333">.</span><span style="color: #0000CC">put</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Amsterda&quot;</span><span style="color: #333333">,</span> Arrays<span style="color: #333333">.</span><span style="color: #0000CC">asList</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Amsterdam Kerkstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Kalverstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Kometensingel&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Elpermeer&quot;</span><span style="color: #333333">));</span>
            values<span style="color: #333333">.</span><span style="color: #0000CC">put</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Amsterdam&quot;</span><span style="color: #333333">,</span> Arrays<span style="color: #333333">.</span><span style="color: #0000CC">asList</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Amsterdam Kerkstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Kalverstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Kometensingel&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Elpermeer&quot;</span><span style="color: #333333">));</span>
            values<span style="color: #333333">.</span><span style="color: #0000CC">put</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Amsterdam &quot;</span><span style="color: #333333">,</span> Arrays<span style="color: #333333">.</span><span style="color: #0000CC">asList</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Amsterdam Kerkstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Kalverstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Kometensingel&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Elpermeer&quot;</span><span style="color: #333333">));</span>
            values<span style="color: #333333">.</span><span style="color: #0000CC">put</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Amsterdam K&quot;</span><span style="color: #333333">,</span> Arrays<span style="color: #333333">.</span><span style="color: #0000CC">asList</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Amsterdam Kerkstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Kalverstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Kometensingel&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Korenbloemstraat&quot;</span><span style="color: #333333">));</span>
            values<span style="color: #333333">.</span><span style="color: #0000CC">put</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Amsterdam Ko&quot;</span><span style="color: #333333">,</span> Arrays<span style="color: #333333">.</span><span style="color: #0000CC">asList</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Amsterdam Korenbloemstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Kompasstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Kometensingel&quot;</span><span style="color: #333333">));</span>
            values<span style="color: #333333">.</span><span style="color: #0000CC">put</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Amsterdam Kor&quot;</span><span style="color: #333333">,</span> Arrays<span style="color: #333333">.</span><span style="color: #0000CC">asList</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Amsterdam Korenbloemstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Korte Leidsedwarsstraat&quot;</span><span style="color: #333333">,</span> <span style="background-color: #fff0f0">&quot;Amsterdam Korte Keizersstraat&quot;</span><span style="color: #333333">));</span>
            <span style="color: #008800; font-weight: bold">return</span> values<span style="color: #333333">;</span>
        <span style="color: #333333">}</span>


        <span style="color: #008800; font-weight: bold">public</span> Observable<span style="color: #333333">&lt;</span>List<span style="color: #333333">&lt;</span>String<span style="color: #333333">&gt;&gt;</span> <span style="color: #0066BB; font-weight: bold">suggest</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">final</span> String input<span style="color: #333333">)</span> <span style="color: #333333">{</span>
            <span style="color: #008800; font-weight: bold">return</span> Observable<span style="color: #333333">.</span><span style="color: #0000CC">fromCallable</span><span style="color: #333333">(()</span> <span style="color: #333333">-&gt;</span> <span style="color: #333333">{</span>
                System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">.</span><span style="color: #0000CC">println</span><span style="color: #333333">(</span>String<span style="color: #333333">.</span><span style="color: #0000CC">format</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Search --&gt; %s&quot;</span><span style="color: #333333">,</span> input<span style="color: #333333">));</span>
                <span style="color: #008800; font-weight: bold">if</span> <span style="color: #333333">(</span>input<span style="color: #333333">.</span><span style="color: #0000CC">length</span><span style="color: #333333">()</span> <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">3</span><span style="color: #333333">)</span> <span style="color: #333333">{</span>
                    Thread<span style="color: #333333">.</span><span style="color: #0000CC">sleep</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">50</span><span style="color: #333333">);</span>
                <span style="color: #333333">}</span>
                <span style="color: #008800; font-weight: bold">if</span> <span style="color: #333333">(</span>input<span style="color: #333333">.</span><span style="color: #0000CC">length</span><span style="color: #333333">()</span> <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">7</span><span style="color: #333333">)</span> <span style="color: #333333">{</span>
                    <span style="color: #008800; font-weight: bold">throw</span> <span style="color: #008800; font-weight: bold">new</span> <span style="color: #0066BB; font-weight: bold">RuntimeException</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Error&quot;</span><span style="color: #333333">);</span>
                <span style="color: #333333">}</span>
                <span style="color: #008800; font-weight: bold">return</span> results<span style="color: #333333">.</span><span style="color: #0000CC">get</span><span style="color: #333333">(</span>input<span style="color: #333333">);</span>
            <span style="color: #333333">}).</span><span style="color: #0000CC">subscribeOn</span><span style="color: #333333">(</span>Schedulers<span style="color: #333333">.</span><span style="color: #0000CC">io</span><span style="color: #333333">());</span>
        <span style="color: #333333">}</span>
    <span style="color: #333333">}</span>
<span style="color: #333333">}</span>
</pre></div>

            </p>
            <h2 id="sub-par-4-2">Exponential Backoff</h2>
            <p>
                When scheduling repeated work <a href="https://en.wikipedia.org/wiki/Exponential_backoff">Exponential backoff</a> can be used to retry a failed request. When the scheduling interval is high (for example 1 hour), this makes sure the request is retried relatively fast so you do not have to wait before the next interval occurs.
            </p>
            <p>
                Exponential backoff can be implemented using the onErrorResumeNext function and then comparing the actual number of invocations with a specified maximum. Each next invocation is delayed exponentially more then the previous invocation.
            </p>
            <p>
                <!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">public</span> <span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">ExponentialBackOff</span> <span style="color: #333333">{</span>
    <span style="color: #008800; font-weight: bold">private</span> <span style="color: #008800; font-weight: bold">static</span> <span style="color: #008800; font-weight: bold">final</span> String RESPONSE <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;[\n&quot;</span> <span style="color: #333333">+</span>
            <span style="background-color: #fff0f0">&quot;  {\&quot;name\&quot;: \&quot;&#39;s-Hertogenbosch\&quot;},\n&quot;</span> <span style="color: #333333">+</span>
            <span style="background-color: #fff0f0">&quot;  {\&quot;name\&quot;: \&quot;Oss\&quot;},\n&quot;</span> <span style="color: #333333">+</span>
            <span style="background-color: #fff0f0">&quot;  {\&quot;name\&quot;: \&quot;Maastricht\&quot;},\n&quot;</span> <span style="color: #333333">+</span>
            <span style="background-color: #fff0f0">&quot;  {\&quot;name\&quot;: \&quot;Utrecht Centraal\&quot;},\n&quot;</span> <span style="color: #333333">+</span>
            <span style="background-color: #fff0f0">&quot;  {\&quot;name\&quot;: \&quot;Groningen\&quot;}\n&quot;</span> <span style="color: #333333">+</span>
            <span style="background-color: #fff0f0">&quot;]&quot;</span><span style="color: #333333">;</span>
    <span style="color: #008800; font-weight: bold">private</span> <span style="color: #008800; font-weight: bold">static</span> StationsApi stationsApi<span style="color: #333333">;</span>

    <span style="color: #008800; font-weight: bold">public</span> <span style="color: #008800; font-weight: bold">static</span> <span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">main</span><span style="color: #333333">(</span>String<span style="color: #333333">[]</span> args<span style="color: #333333">)</span> <span style="color: #008800; font-weight: bold">throws</span> IOException<span style="color: #333333">,</span> InterruptedException <span style="color: #333333">{</span>
        <span style="color: #008800; font-weight: bold">final</span> TestScheduler testScheduler <span style="color: #333333">=</span> Schedulers<span style="color: #333333">.</span><span style="color: #0000CC">test</span><span style="color: #333333">();</span>
<span style="color: #888888">//        final Scheduler testScheduler = Schedulers.immediate();</span>
        <span style="color: #008800; font-weight: bold">final</span> <span style="color: #333399; font-weight: bold">int</span> maxFails <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">3</span><span style="color: #333333">;</span>
        <span style="color: #008800; font-weight: bold">final</span> <span style="color: #333399; font-weight: bold">int</span> iterations <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">5</span> <span style="color: #333333">+</span> maxFails<span style="color: #333333">;</span>
        <span style="color: #008800; font-weight: bold">final</span> MockWebServer mockWebServer <span style="color: #333333">=</span> prepareResponses<span style="color: #333333">(</span>iterations<span style="color: #333333">,</span> maxFails<span style="color: #333333">);</span>
        stationsApi <span style="color: #333333">=</span> RetroFitFactory<span style="color: #333333">.</span><span style="color: #0000CC">getApi</span><span style="color: #333333">(</span>mockWebServer<span style="color: #333333">.</span><span style="color: #0000CC">url</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;/&quot;</span><span style="color: #333333">).</span><span style="color: #0000CC">toString</span><span style="color: #333333">(),</span> testScheduler<span style="color: #333333">).</span><span style="color: #0000CC">create</span><span style="color: #333333">(</span>StationsApi<span style="color: #333333">.</span><span style="color: #0000CC">class</span><span style="color: #333333">);</span>

        <span style="color: #888888">// Demo</span>
        <span style="color: #008800; font-weight: bold">final</span> Subscription subsription <span style="color: #333333">=</span> Observable<span style="color: #333333">.</span><span style="color: #0000CC">interval</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">1</span><span style="color: #333333">,</span> TimeUnit<span style="color: #333333">.</span><span style="color: #0000CC">HOURS</span><span style="color: #333333">,</span> testScheduler<span style="color: #333333">)</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">doOnNext</span><span style="color: #333333">(</span>hour <span style="color: #333333">-&gt;</span> System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">.</span><span style="color: #0000CC">println</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;------------ &quot;</span> <span style="color: #333333">+</span> hour <span style="color: #333333">+</span> <span style="background-color: #fff0f0">&quot; hour(s) ------------&quot;</span><span style="color: #333333">))</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">switchMap</span><span style="color: #333333">(</span>i <span style="color: #333333">-&gt;</span> updateStations<span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">4</span><span style="color: #333333">,</span> <span style="color: #0000DD; font-weight: bold">1</span><span style="color: #333333">,</span> testScheduler<span style="color: #333333">)</span>
                        <span style="color: #333333">.</span><span style="color: #0000CC">doOnError</span><span style="color: #333333">(</span>throwable <span style="color: #333333">-&gt;</span> System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">.</span><span style="color: #0000CC">println</span><span style="color: #333333">(</span>throwable<span style="color: #333333">.</span><span style="color: #0000CC">getMessage</span><span style="color: #333333">()))</span>
                        <span style="color: #333333">.</span><span style="color: #0000CC">onErrorResumeNext</span><span style="color: #333333">(</span>throwable <span style="color: #333333">-&gt;</span> Observable<span style="color: #333333">.</span><span style="color: #0000CC">empty</span><span style="color: #333333">()))</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">subscribe</span><span style="color: #333333">(</span>System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">::</span>println<span style="color: #333333">);</span>

        <span style="color: #008800; font-weight: bold">for</span> <span style="color: #333333">(</span><span style="color: #333399; font-weight: bold">int</span> i <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span><span style="color: #333333">;</span> i <span style="color: #333333">&lt;</span> iterations<span style="color: #333333">;</span> i<span style="color: #333333">++)</span> <span style="color: #333333">{</span>
            testScheduler<span style="color: #333333">.</span><span style="color: #0000CC">advanceTimeBy</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">1</span><span style="color: #333333">,</span> TimeUnit<span style="color: #333333">.</span><span style="color: #0000CC">HOURS</span><span style="color: #333333">);</span>
        <span style="color: #333333">}</span>
        <span style="color: #888888">// Demo</span>

        subsription<span style="color: #333333">.</span><span style="color: #0000CC">unsubscribe</span><span style="color: #333333">();</span>
        mockWebServer<span style="color: #333333">.</span><span style="color: #0000CC">shutdown</span><span style="color: #333333">();</span>
    <span style="color: #333333">}</span>

    <span style="color: #008800; font-weight: bold">private</span> <span style="color: #008800; font-weight: bold">static</span> MockWebServer <span style="color: #0066BB; font-weight: bold">prepareResponses</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">final</span> <span style="color: #333399; font-weight: bold">int</span> iterations<span style="color: #333333">,</span> <span style="color: #008800; font-weight: bold">final</span> <span style="color: #333399; font-weight: bold">int</span> maxFailes<span style="color: #333333">)</span> <span style="color: #008800; font-weight: bold">throws</span> IOException <span style="color: #333333">{</span>
        <span style="color: #008800; font-weight: bold">final</span> MockWebServer mockWebServer <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">new</span> MockWebServer<span style="color: #333333">();</span>
        <span style="color: #008800; font-weight: bold">for</span> <span style="color: #333333">(</span><span style="color: #333399; font-weight: bold">int</span> i <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span><span style="color: #333333">;</span> i <span style="color: #333333">&lt;</span> iterations <span style="color: #333333">+</span> maxFailes<span style="color: #333333">;</span> i<span style="color: #333333">++)</span> <span style="color: #333333">{</span>
            <span style="color: #008800; font-weight: bold">if</span> <span style="color: #333333">(</span>i <span style="color: #333333">&gt;=</span> <span style="color: #0000DD; font-weight: bold">2</span> <span style="color: #333333">&amp;&amp;</span> i <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">2</span> <span style="color: #333333">+</span> maxFailes<span style="color: #333333">)</span> <span style="color: #333333">{</span>
                mockWebServer<span style="color: #333333">.</span><span style="color: #0000CC">enqueue</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">new</span> MockResponse<span style="color: #333333">().</span><span style="color: #0000CC">setResponseCode</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">500</span><span style="color: #333333">));</span>
            <span style="color: #333333">}</span> <span style="color: #008800; font-weight: bold">else</span> <span style="color: #333333">{</span>
                mockWebServer<span style="color: #333333">.</span><span style="color: #0000CC">enqueue</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">new</span> MockResponse<span style="color: #333333">().</span><span style="color: #0000CC">setBody</span><span style="color: #333333">(</span>RESPONSE<span style="color: #333333">).</span><span style="color: #0000CC">setResponseCode</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">200</span><span style="color: #333333">));</span>
            <span style="color: #333333">}</span>
        <span style="color: #333333">}</span>
        mockWebServer<span style="color: #333333">.</span><span style="color: #0000CC">start</span><span style="color: #333333">();</span>
        <span style="color: #008800; font-weight: bold">return</span> mockWebServer<span style="color: #333333">;</span>
    <span style="color: #333333">}</span>

    <span style="color: #008800; font-weight: bold">private</span> <span style="color: #008800; font-weight: bold">static</span> Observable<span style="color: #333333">&lt;</span>List<span style="color: #333333">&lt;</span>Station<span style="color: #333333">&gt;&gt;</span> <span style="color: #0066BB; font-weight: bold">updateStations</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">final</span> <span style="color: #333399; font-weight: bold">int</span> maxRetries<span style="color: #333333">,</span> <span style="color: #008800; font-weight: bold">final</span> <span style="color: #333399; font-weight: bold">int</span> numRetries<span style="color: #333333">,</span> <span style="color: #008800; font-weight: bold">final</span> Scheduler scheduler<span style="color: #333333">)</span> <span style="color: #333333">{</span>
        System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">.</span><span style="color: #0000CC">println</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Retrieve stations&quot;</span><span style="color: #333333">);</span>
        <span style="color: #008800; font-weight: bold">final</span> <span style="color: #333399; font-weight: bold">long</span> delay <span style="color: #333333">=</span> <span style="color: #333333">(</span><span style="color: #333399; font-weight: bold">long</span><span style="color: #333333">)</span> Math<span style="color: #333333">.</span><span style="color: #0000CC">pow</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">2</span><span style="color: #333333">,</span> numRetries<span style="color: #333333">)</span> <span style="color: #333333">*</span> <span style="color: #0000DD; font-weight: bold">1000</span><span style="color: #333333">;</span>
        <span style="color: #008800; font-weight: bold">return</span> stationsApi<span style="color: #333333">.</span><span style="color: #0000CC">retrieveStations</span><span style="color: #333333">()</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">doOnError</span><span style="color: #333333">(</span>throwable <span style="color: #333333">-&gt;</span> <span style="color: #333333">{</span>
                    System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">.</span><span style="color: #0000CC">println</span><span style="color: #333333">(</span>String<span style="color: #333333">.</span><span style="color: #0000CC">format</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Error. Retrying again in %d milliseconds&quot;</span><span style="color: #333333">,</span> delay<span style="color: #333333">));</span>
                <span style="color: #333333">})</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">onErrorResumeNext</span><span style="color: #333333">(</span>throwable <span style="color: #333333">-&gt;</span> <span style="color: #333333">{</span>
                    <span style="color: #008800; font-weight: bold">if</span> <span style="color: #333333">(</span>numRetries <span style="color: #333333">&lt;</span> maxRetries<span style="color: #333333">)</span> <span style="color: #333333">{</span>
                        System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">.</span><span style="color: #0000CC">println</span><span style="color: #333333">(</span>String<span style="color: #333333">.</span><span style="color: #0000CC">format</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Retrying %d time&quot;</span><span style="color: #333333">,</span> numRetries<span style="color: #333333">));</span>
                        <span style="color: #008800; font-weight: bold">return</span> Observable<span style="color: #333333">.</span><span style="color: #0000CC">just</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">1</span><span style="color: #333333">).</span><span style="color: #0000CC">delay</span><span style="color: #333333">(</span>delay<span style="color: #333333">,</span> TimeUnit<span style="color: #333333">.</span><span style="color: #0000CC">MILLISECONDS</span><span style="color: #333333">,</span> scheduler<span style="color: #333333">)</span>
                                <span style="color: #333333">.</span><span style="color: #0000CC">switchMap</span><span style="color: #333333">(</span>i <span style="color: #333333">-&gt;</span> updateStations<span style="color: #333333">(</span>maxRetries<span style="color: #333333">,</span> numRetries <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">1</span><span style="color: #333333">,</span> scheduler<span style="color: #333333">));</span>
                    <span style="color: #333333">}</span>

                    <span style="color: #008800; font-weight: bold">return</span> Observable<span style="color: #333333">.</span><span style="color: #0000CC">error</span><span style="color: #333333">(</span>throwable<span style="color: #333333">);</span>
                <span style="color: #333333">});</span>
    <span style="color: #333333">}</span>

    <span style="color: #008800; font-weight: bold">private</span> <span style="color: #008800; font-weight: bold">interface</span> <span style="color: #BB0066; font-weight: bold">StationsApi</span> <span style="color: #333333">{</span>

        <span style="color: #555555; font-weight: bold">@GET</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;/stations&quot;</span><span style="color: #333333">)</span>
        Observable<span style="color: #333333">&lt;</span>List<span style="color: #333333">&lt;</span>Station<span style="color: #333333">&gt;&gt;</span> <span style="color: #0066BB; font-weight: bold">retrieveStations</span><span style="color: #333333">();</span>
    <span style="color: #333333">}</span>

    <span style="color: #008800; font-weight: bold">private</span> <span style="color: #008800; font-weight: bold">static</span> <span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">Station</span> <span style="color: #333333">{</span>
        String name<span style="color: #333333">;</span>

        <span style="color: #555555; font-weight: bold">@Override</span>
        <span style="color: #008800; font-weight: bold">public</span> String <span style="color: #0066BB; font-weight: bold">toString</span><span style="color: #333333">()</span> <span style="color: #333333">{</span>
            <span style="color: #008800; font-weight: bold">final</span> StringBuilder sb <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">new</span> StringBuilder<span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;Station{&quot;</span><span style="color: #333333">);</span>
            sb<span style="color: #333333">.</span><span style="color: #0000CC">append</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;name=&#39;&quot;</span><span style="color: #333333">).</span><span style="color: #0000CC">append</span><span style="color: #333333">(</span>name<span style="color: #333333">).</span><span style="color: #0000CC">append</span><span style="color: #333333">(</span><span style="color: #0044DD">&#39;\&#39;&#39;</span><span style="color: #333333">);</span>
            sb<span style="color: #333333">.</span><span style="color: #0000CC">append</span><span style="color: #333333">(</span><span style="color: #0044DD">&#39;}&#39;</span><span style="color: #333333">);</span>
            <span style="color: #008800; font-weight: bold">return</span> sb<span style="color: #333333">.</span><span style="color: #0000CC">toString</span><span style="color: #333333">();</span>
        <span style="color: #333333">}</span>
    <span style="color: #333333">}</span>
<span style="color: #333333">}</span>
</pre></div>

            </p>
            <h2 id="sub-par-4-3">SQS long polling</h2>
            <p>
                Demonstrates SQS long polling with RxJava. A long polling request may return 0 or more messages up to the configured maximum. Those messages are processed in parallel
                and a new long polling request is started when all messages are processed.
            </p>
            <p>
                <!-- HTML generated using hilite.me --><!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">rx.Observable</span><span style="color: #333333">;</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">rx.schedulers.Schedulers</span><span style="color: #333333">;</span>

<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">java.util.ArrayList</span><span style="color: #333333">;</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">java.util.List</span><span style="color: #333333">;</span>
<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">java.util.Random</span><span style="color: #333333">;</span>

<span style="color: #008800; font-weight: bold">public</span> <span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">SqsReceiverSample</span> <span style="color: #333333">{</span>
    <span style="color: #008800; font-weight: bold">private</span> <span style="color: #008800; font-weight: bold">static</span> <span style="color: #008800; font-weight: bold">final</span> Random RANDOM <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">new</span> Random<span style="color: #333333">();</span>

    <span style="color: #008800; font-weight: bold">public</span> <span style="color: #008800; font-weight: bold">static</span> <span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">main</span><span style="color: #333333">(</span>String<span style="color: #333333">[]</span> args<span style="color: #333333">)</span> <span style="color: #008800; font-weight: bold">throws</span> InterruptedException <span style="color: #333333">{</span>
        <span style="color: #008800; font-weight: bold">new</span> <span style="color: #0066BB; font-weight: bold">SqsReceiverSample</span><span style="color: #333333">().</span><span style="color: #0000CC">run</span><span style="color: #333333">();</span>
    <span style="color: #333333">}</span>

    <span style="color: #008800; font-weight: bold">private</span> <span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">run</span><span style="color: #333333">()</span> <span style="color: #008800; font-weight: bold">throws</span> InterruptedException <span style="color: #333333">{</span>
        receive<span style="color: #333333">()</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">concatMap</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">this</span><span style="color: #333333">::</span>handleMessages<span style="color: #333333">)</span> <span style="color: #888888">// The concatMap makes sure the polling of the next messages starts if all the inner observables complete.</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">doOnError</span><span style="color: #333333">(</span><span style="color: #997700; font-weight: bold">Throwable:</span><span style="color: #333333">:</span>printStackTrace<span style="color: #333333">)</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">doOnCompleted</span><span style="color: #333333">(()</span> <span style="color: #333333">-&gt;</span> System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">.</span><span style="color: #0000CC">println</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;COMPLETED -----------------------------------&quot;</span><span style="color: #333333">))</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">repeat</span><span style="color: #333333">()</span> <span style="color: #888888">// subscribe again to this observable when this observable completes</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">retry</span><span style="color: #333333">()</span> <span style="color: #888888">// subscribe again to this onservable in case of errors</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">subscribe</span><span style="color: #333333">();</span>

        Thread<span style="color: #333333">.</span><span style="color: #0000CC">sleep</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">10000</span><span style="color: #333333">);</span>
    <span style="color: #333333">}</span>

    <span style="color: #888888">/**</span>
<span style="color: #888888">     * Simluate an SQS long-polling request which returns 0 to max messages at once.</span>
<span style="color: #888888">     * @return</span>
<span style="color: #888888">     */</span>
    <span style="color: #008800; font-weight: bold">private</span> Observable<span style="color: #333333">&lt;</span>List<span style="color: #333333">&lt;</span>String<span style="color: #333333">&gt;&gt;</span> <span style="color: #0066BB; font-weight: bold">receive</span><span style="color: #333333">()</span> <span style="color: #333333">{</span>
        <span style="color: #008800; font-weight: bold">return</span> Observable<span style="color: #333333">.</span><span style="color: #0000CC">fromCallable</span><span style="color: #333333">(()</span> <span style="color: #333333">-&gt;</span> <span style="color: #333333">{</span>
            System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">.</span><span style="color: #0000CC">println</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;-----------------------------------------&quot;</span><span style="color: #333333">);</span>
            <span style="color: #008800; font-weight: bold">final</span> ArrayList<span style="color: #333333">&lt;</span>String<span style="color: #333333">&gt;</span> result <span style="color: #333333">=</span> <span style="color: #008800; font-weight: bold">new</span> ArrayList<span style="color: #333333">&lt;&gt;(</span>RANDOM<span style="color: #333333">.</span><span style="color: #0000CC">nextInt</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">8</span><span style="color: #333333">)</span> <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">1</span><span style="color: #333333">);</span>
            <span style="color: #008800; font-weight: bold">for</span> <span style="color: #333333">(</span><span style="color: #333399; font-weight: bold">int</span> i <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span><span style="color: #333333">;</span> i <span style="color: #333333">&lt;</span> RANDOM<span style="color: #333333">.</span><span style="color: #0000CC">nextInt</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">8</span><span style="color: #333333">)</span> <span style="color: #333333">+</span> <span style="color: #0000DD; font-weight: bold">1</span><span style="color: #333333">;</span> i<span style="color: #333333">++)</span> <span style="color: #333333">{</span>
                result<span style="color: #333333">.</span><span style="color: #0000CC">add</span><span style="color: #333333">(</span>String<span style="color: #333333">.</span><span style="color: #0000CC">valueOf</span><span style="color: #333333">(</span>i<span style="color: #333333">));</span>
            <span style="color: #333333">}</span>
            System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">.</span><span style="color: #0000CC">println</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;MESSAGES TO HANDLE &quot;</span> <span style="color: #333333">+</span> result<span style="color: #333333">.</span><span style="color: #0000CC">size</span><span style="color: #333333">());</span>
            <span style="color: #008800; font-weight: bold">return</span> result<span style="color: #333333">;</span>
        <span style="color: #333333">});</span>
    <span style="color: #333333">}</span>

    <span style="color: #888888">/**</span>
<span style="color: #888888">     * Split the messages and handle each message using a flatMap call</span>
<span style="color: #888888">     * @param messages</span>
<span style="color: #888888">     * @return</span>
<span style="color: #888888">     */</span>
    <span style="color: #008800; font-weight: bold">private</span> Observable<span style="color: #333333">&lt;</span>String<span style="color: #333333">&gt;</span> <span style="color: #0066BB; font-weight: bold">handleMessages</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">final</span> List<span style="color: #333333">&lt;</span>String<span style="color: #333333">&gt;</span> messages<span style="color: #333333">)</span> <span style="color: #333333">{</span>
        <span style="color: #008800; font-weight: bold">return</span> Observable<span style="color: #333333">.</span><span style="color: #0000CC">from</span><span style="color: #333333">(</span>messages<span style="color: #333333">)</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">flatMap</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">this</span><span style="color: #333333">::</span>handleMessage<span style="color: #333333">)</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">flatMap</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">this</span><span style="color: #333333">::</span>deleteMessage<span style="color: #333333">)</span>
                <span style="color: #333333">.</span><span style="color: #0000CC">onErrorResumeNext</span><span style="color: #333333">(</span>Observable<span style="color: #333333">.</span><span style="color: #0000CC">empty</span><span style="color: #333333">());</span>
    <span style="color: #333333">}</span>

    <span style="color: #888888">/**</span>
<span style="color: #888888">     * This method creates an observable which handles each message in its separate thread.</span>
<span style="color: #888888">     * @param message</span>
<span style="color: #888888">     * @return</span>
<span style="color: #888888">     */</span>
    <span style="color: #008800; font-weight: bold">private</span> Observable<span style="color: #333333">&lt;</span>String<span style="color: #333333">&gt;</span> <span style="color: #0066BB; font-weight: bold">handleMessage</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">final</span> String message<span style="color: #333333">)</span> <span style="color: #333333">{</span>
        <span style="color: #008800; font-weight: bold">return</span> Observable<span style="color: #333333">.</span><span style="color: #0000CC">fromCallable</span><span style="color: #333333">(()</span> <span style="color: #333333">-&gt;</span> <span style="color: #333333">{</span>
            Thread<span style="color: #333333">.</span><span style="color: #0000CC">sleep</span><span style="color: #333333">(</span>RANDOM<span style="color: #333333">.</span><span style="color: #0000CC">nextInt</span><span style="color: #333333">(</span><span style="color: #0000DD; font-weight: bold">1500</span><span style="color: #333333">));</span>
            System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">.</span><span style="color: #0000CC">println</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;HANDLE: &quot;</span> <span style="color: #333333">+</span> message<span style="color: #333333">);</span>
            <span style="color: #008800; font-weight: bold">return</span> message<span style="color: #333333">;</span>
        <span style="color: #333333">}).</span><span style="color: #0000CC">subscribeOn</span><span style="color: #333333">(</span>Schedulers<span style="color: #333333">.</span><span style="color: #0000CC">io</span><span style="color: #333333">());</span>
    <span style="color: #333333">}</span>

    <span style="color: #888888">/**</span>
<span style="color: #888888">     * After processing the message make sure to delete it from the queue.</span>
<span style="color: #888888">     * @param message</span>
<span style="color: #888888">     * @return</span>
<span style="color: #888888">     */</span>
    <span style="color: #008800; font-weight: bold">private</span> Observable<span style="color: #333333">&lt;</span>String<span style="color: #333333">&gt;</span> <span style="color: #0066BB; font-weight: bold">deleteMessage</span><span style="color: #333333">(</span><span style="color: #008800; font-weight: bold">final</span> String message<span style="color: #333333">)</span> <span style="color: #333333">{</span>
        <span style="color: #008800; font-weight: bold">return</span> Observable<span style="color: #333333">.</span><span style="color: #0000CC">fromCallable</span><span style="color: #333333">(()</span> <span style="color: #333333">-&gt;</span> <span style="color: #333333">{</span>
            System<span style="color: #333333">.</span><span style="color: #0000CC">out</span><span style="color: #333333">.</span><span style="color: #0000CC">println</span><span style="color: #333333">(</span><span style="background-color: #fff0f0">&quot;DELETE: &quot;</span> <span style="color: #333333">+</span> message<span style="color: #333333">);</span>
            <span style="color: #008800; font-weight: bold">return</span> message<span style="color: #333333">;</span>
        <span style="color: #333333">});</span>
    <span style="color: #333333">}</span>
<span style="color: #333333">}</span>
</pre></div>
            </p>
            <h2 id="sub-par-4-4">Reacting to user input</h2>
            <p>
                This demo consists of a user interface containing a zipcode and housenumber fields. We want to retrieve the addess for zipcode and housenumber combination when both fields are filled-in by the user and valid. When the housenumber changes, we want to wait 300ms before exeuting the request. This demo is written in Android/Kotlin and uses an extension function to convert the EditText input to an Observable.
            </p>
            <p>
                <!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-weight: bold">class</span> <span style="color: #BB0066; font-weight: bold">MainActivity</span> : AppCompatActivity() {
    <span style="color: #008800; font-weight: bold">override</span> <span style="color: #008800; font-weight: bold">fun</span> <span style="color: #0066BB; font-weight: bold">onCreate</span>(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        <span style="color: #008800; font-weight: bold">val</span> myApi = Retrofit.Builder()
                .baseUrl(<span style="background-color: #fff0f0">&quot;SERVER_URL&quot;</span>)
                .addCallAdapterFactory(RxJava2CallAdapterFactory.createWithScheduler(Schedulers.io()))
                .addConverterFactory(GsonConverterFactory.create(GsonBuilder().create()))
                .build().create(MyApi::class.java)

        <span style="color: #008800; font-weight: bold">val</span> zipcodeSubject = zipCode.toObservable()
        <span style="color: #008800; font-weight: bold">val</span> houseNumberSubject = houseNumber.toObservable()

        Observable.combineLatest&lt;String, String, Pair&lt;String, String&gt;&gt;(
                zipcodeSubject
                        .filter { postcode -&gt; zipCodeRegExp.matcher(postcode).matches() },
                houseNumberSubject
                        .map { it.trim() }
                        .filter({ it.isNotEmpty() })
                        .debounce(<span style="color: #6600EE; font-weight: bold">300</span>, TimeUnit.MILLISECONDS),
                BiFunction { t1, t2 -&gt; Pair(t1, t2) }
        )
                .switchMap { myApi.retrieveAddress(it.first, it.second) }
                .observeOn(AndroidSchedulers.mainThread())
                .subscribe({ Toast.makeText(<span style="color: #008800; font-weight: bold">this</span>, it.street, Toast.LENGTH_SHORT).show() }, { it.printStackTrace() })
    }

    companion object {
        <span style="color: #008800; font-weight: bold">private</span> <span style="color: #008800; font-weight: bold">val</span> zipCodeRegExp = Pattern.compile(<span style="background-color: #fff0f0">&quot;[0-9]{4}[A-z]{2}&quot;</span>)
    }
}

<span style="color: #008800; font-weight: bold">fun</span> EditText.toObservable(): Observable&lt;String&gt; {
    <span style="color: #008800; font-weight: bold">val</span> subject = PublishSubject.create&lt;String&gt;()
    <span style="color: #008800; font-weight: bold">this</span>.addTextChangedListener(object : TextWatcher {
        <span style="color: #008800; font-weight: bold">override</span> <span style="color: #008800; font-weight: bold">fun</span> <span style="color: #0066BB; font-weight: bold">afterTextChanged</span>(p0: Editable?) {
            <span style="color: #888888">// Ignore</span>
        }

        <span style="color: #008800; font-weight: bold">override</span> <span style="color: #008800; font-weight: bold">fun</span> <span style="color: #0066BB; font-weight: bold">beforeTextChanged</span>(p0: CharSequence?, p1: Int, p2: Int, p3: Int) {
            <span style="color: #888888">// Ignore</span>
        }

        <span style="color: #008800; font-weight: bold">override</span> <span style="color: #008800; font-weight: bold">fun</span> <span style="color: #0066BB; font-weight: bold">onTextChanged</span>(charSequence: CharSequence, start: Int, before: Int, count: Int) {
            subject.onNext(charSequence.toString())
        }
    })
    <span style="color: #008800; font-weight: bold">return</span> subject
}
</pre></div>


            </p>
        </div>
    </div>
</div>

<script src="vendor/jquery/jquery.min.js"></script>
<script src="vendor/bootstrap/js/bootstrap.min.js"></script>
<script>
    $(document).ready(function () {
        var sidebarMainMenu = $('#sidebar-menu .main-menu');
        var staticContent = $('#static-content');
        staticContent.find('h1').each(function () {
            sidebarMainMenu.append('<li id="' + $(this).attr('id') + '-menu"><a href="#' + $(this).attr('id') + '">' + $(this).html() + '</li>');
            title = sidebarMainMenu.find('#' + $(this).attr('id'));
        });
        staticContent.find('h2').each(function () {
            prevTitle = sidebarMainMenu.find('#' + $(this).prevAll('h1').first().attr('id') + '-menu');
            prevTitle.not(":has(ul)").append('<ul class="sub-menu"></ul>');
            prevTitle.find('.sub-menu').append('<li id="' + $(this).attr('id') + '-menu"><a href="#' + $(this).attr('id') + '">' + $(this).html() + '</li>');
        });
        sidebarMainMenu.affix({
            offset: {
                top: 0  // To Modify according to the height offset
            }
        });
    });
</script>
</body>
</html>